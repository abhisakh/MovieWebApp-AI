{% extends "base.html" %}

{% block title %}{{ user.name }}'s Movies{% endblock %}

{% block content %}
<section class="movies-section">

    <h2>üé¨ {{ user.name }}‚Äôs Favorite Movies</h2>

    <!-- üéû Toggle Add Movie Button -->
    <button id="toggleAddMovie" class="toggle-btn">‚ûï Add Movie</button>

    <!-- üé¨ Collapsible Add Movie Form -->
    <div id="addMovieForm" class="collapsible-form">
        <form method="POST" action="{{ url_for('add_movie', user_id=user.id) }}" class="add-movie-form">
            <h3>Add a New Movie</h3>

            <div>
                <label for="movie_name">üéû Movie Name *</label>
                <input type="text" id="movie_name" name="movie_name" placeholder="Enter movie name" required>
            </div>

            <div>
                <label for="director">üé¨ Director</label>
                <input type="text" id="director" name="director" placeholder="Optional">
            </div>

            <div>
                <label for="year">üìÖ Year</label>
                <input type="number" id="year" name="year" min="1888" max="{{ current_year|int + 1 }}" placeholder="e.g. 2009">
            </div>

            <div>
                <label for="rating">‚≠ê Rating (0‚Äì10)</label>
                <input type="number" id="rating" name="rating" step="0.1" min="0" max="10" placeholder="Optional">
            </div>

            <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                <button type="submit">üîç Search & Add</button>
                <button type="button" id="cancelAddMovie" class="cancel-btn">‚úñ Cancel</button>
            </div>

            <small>‚ÑπÔ∏è The app will automatically fetch details from OMDb.</small>
        </form>
    </div>

    <hr>

    <!-- Movies Grid -->
    <div class="movies-grid">
        {% if movies %}
            {% for movie in movies %}
            <div class="movie-card">
                <img src="{{ movie.poster_url or '/static/no-image.png' }}" alt="{{ movie.name }}"
                     onerror="this.src='/static/no-image.png';">

                <div class="movie-details">
                    <h3>{{ movie.name }}</h3>
                    <p><strong>Director:</strong> {{ movie.director }}</p>
                    <p><strong>Year:</strong> {{ movie.year }}</p>
                    <p>
                        Rating:
                        {% set stars = (movie.rating / 2) | float %}
                        {% set stars_rounded = (stars * 4) | round / 4 %}
                        {% for i in range(1, 6) %}
                            {% if stars_rounded >= i %}
                                <span class="star">&#9733;</span>
                            {% else %}
                                <span class="star-empty">&#9733;</span>
                            {% endif %}
                        {% endfor %}
                        ({{ movie.rating }}/10)
                    </p>
                </div>

                <!-- ‚úèÔ∏è Toggle Update Button -->
                <button type="button" class="toggle-update-btn">‚úèÔ∏è Rename</button>

                <!-- Collapsible Update Form -->
                <div class="collapsible-update-form">
                    <form action="{{ url_for('update_movie', user_id=user.id, movie_id=movie.id) }}"
                          method="POST" class="update-form">
                        <input type="text" name="new_title" placeholder="Rename movie..." required>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button type="submit">Update</button>
                            <button type="button" class="cancel-update-btn">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Delete Button -->
                <form action="{{ url_for('delete_movie', user_id=user.id, movie_id=movie.id) }}"
                      method="POST" class="delete-form">
                    <button type="submit">Delete</button>
                </form>
            </div>
            {% endfor %}
        {% else %}
            <p>No movies found for {{ user.name }} yet. Add a new movie above! üé¨</p>
        {% endif %}
    </div>
</section>

<!-- üé¨ Collapsible Scripts -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Toggle Add Movie Form
    const toggleAddBtn = document.getElementById("toggleAddMovie");
    const addFormContainer = document.getElementById("addMovieForm");
    const cancelAddBtn = document.getElementById("cancelAddMovie");

    toggleAddBtn?.addEventListener("click", () => {
        addFormContainer.classList.toggle("open");
        toggleAddBtn.textContent = addFormContainer.classList.contains("open")
            ? "‚úñ Close Form"
            : "‚ûï Add Movie";
    });

    cancelAddBtn?.addEventListener("click", () => {
        addFormContainer.classList.remove("open");
        toggleAddBtn.textContent = "‚ûï Add Movie";
    });

    // Toggle Update Forms
    const updateButtons = document.querySelectorAll('.toggle-update-btn');
    updateButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const formContainer = btn.nextElementSibling;
            formContainer.classList.toggle('open');
        });
    });

    const cancelUpdateButtons = document.querySelectorAll('.cancel-update-btn');
    cancelUpdateButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const formContainer = btn.closest('.collapsible-update-form');
            formContainer.classList.remove('open');
        });
    });
});
</script>
{% endblock %}
